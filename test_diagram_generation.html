<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Diagram Generation - Test Page</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        #diagram { margin: 20px 0; }
        .loading { color: #666; font-style: italic; }
    </style>
</head>
<body>
    <h1>üîß Azure Diagram Generation - Debug & Test Tool</h1>
    
    <div class="test-section">
        <h2>üìã Problem Analysis</h2>
        <p><strong>Status:</strong> <span id="analysis-status">Issues identified and fixed</span></p>
        <ul>
            <li>‚úÖ Service name validation with auto-correction implemented</li>
            <li>‚úÖ Enhanced error messages with suggestions</li>
            <li>‚úÖ Common service name aliases supported</li>
            <li>‚úÖ APIs tested and working correctly</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üß™ API Test Suite</h2>
        
        <h3>Test 1: Basic Diagram Generation</h3>
        <button onclick="testBasicGeneration()">Test Basic API</button>
        <div id="test1-result"></div>

        <h3>Test 2: Service Name Auto-Correction</h3>
        <button onclick="testAutoCorrection()">Test Auto-Correction</button>
        <div id="test2-result"></div>

        <h3>Test 3: Invalid Service Handling</h3>
        <button onclick="testInvalidServices()">Test Error Handling</button>
        <div id="test3-result"></div>

        <h3>Test 4: Complex Architecture</h3>
        <button onclick="testComplexArchitecture()">Test Complex Generation</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <h2>üé® Interactive Diagram Generator</h2>
        <textarea id="requirements" placeholder="Describe your Azure architecture requirements...">I need a web application with Azure Kubernetes Service, SQL database, monitoring, and security services</textarea>
        <br>
        <button onclick="generateFromText()">Generate Architecture</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="generation-result"></div>
        <div id="diagram"></div>
    </div>

    <div class="test-section">
        <h2>üìä Service Name Reference</h2>
        <button onclick="showServiceReference()">Show Valid Service Names</button>
        <div id="service-reference"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8001';

        async function makeAPICall(endpoint, data) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                return { success: response.ok, data: result, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        function displayResult(elementId, result, title = '') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            
            let html = title ? `<h4>${title} (${timestamp})</h4>` : '';
            
            if (result.success) {
                html += `<div class="success">
                    <strong>‚úÖ Success</strong>
                    <pre>${JSON.stringify(result.data, null, 2).substring(0, 500)}${JSON.stringify(result.data, null, 2).length > 500 ? '...' : ''}</pre>
                </div>`;
            } else {
                html += `<div class="error">
                    <strong>‚ùå Failed</strong>
                    <pre>${result.error || JSON.stringify(result.data, null, 2)}</pre>
                </div>`;
            }
            
            element.innerHTML = html;
        }

        async function testBasicGeneration() {
            displayResult('test1-result', { success: false, error: 'Testing...' }, 'Basic API Test');
            
            const result = await makeAPICall('/generate-azure-diagram', {
                business_objective: 'Test basic generation',
                compute_services: ['virtual_machines'],
                network_services: ['virtual_network'],
                security_services: ['key_vault']
            });
            
            displayResult('test1-result', result, 'Basic API Test');
        }

        async function testAutoCorrection() {
            displayResult('test2-result', { success: false, error: 'Testing...' }, 'Auto-Correction Test');
            
            const result = await makeAPICall('/generate-azure-diagram', {
                business_objective: 'Test auto-correction',
                compute_services: ['app_service', 'kubernetes', 'vm'], // These should be auto-corrected
                monitoring_services: ['azure_monitor', 'app_insights']  // These should be auto-corrected
            });
            
            displayResult('test2-result', result, 'Auto-Correction Test');
        }

        async function testInvalidServices() {
            displayResult('test3-result', { success: false, error: 'Testing...' }, 'Error Handling Test');
            
            const result = await makeAPICall('/generate-azure-diagram', {
                compute_services: ['completely_invalid_service', 'another_fake_service']
            });
            
            displayResult('test3-result', result, 'Error Handling Test');
        }

        async function testComplexArchitecture() {
            displayResult('test4-result', { success: false, error: 'Testing...' }, 'Complex Architecture Test');
            
            const result = await makeAPICall('/generate-azure-diagram', {
                business_objective: 'Complex enterprise architecture',
                compute_services: ['aks', 'app_services', 'functions'],
                network_services: ['virtual_network', 'load_balancer', 'application_gateway'],
                database_services: ['sql_database', 'cosmos_db', 'redis'],
                storage_services: ['blob_storage', 'file_storage'],
                security_services: ['key_vault', 'security_center'],
                monitoring_services: ['monitor', 'application_insights'],
                integration_services: ['logic_apps', 'api_management']
            });
            
            displayResult('test4-result', result, 'Complex Architecture Test');
        }

        async function generateFromText() {
            const requirements = document.getElementById('requirements').value;
            if (!requirements.trim()) {
                displayResult('generation-result', { success: false, error: 'Please enter requirements' });
                return;
            }

            displayResult('generation-result', { success: false, error: 'Generating...' }, 'Text-Based Generation');
            
            const result = await makeAPICall('/generate-simplified-architecture', {
                free_text_input: requirements
            });
            
            displayResult('generation-result', result, 'Text-Based Generation');
            
            // If successful, try to display the diagram
            if (result.success && result.data.svg_diagram) {
                document.getElementById('diagram').innerHTML = `
                    <h4>Generated Diagram:</h4>
                    <div style="border: 1px solid #ccc; padding: 10px; background: white;">
                        ${result.data.svg_diagram}
                    </div>
                `;
            }
        }

        function clearResults() {
            ['test1-result', 'test2-result', 'test3-result', 'test4-result', 'generation-result', 'diagram', 'service-reference'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        function showServiceReference() {
            const services = {
                'Compute Services': ['virtual_machines', 'aks', 'app_services', 'web_apps', 'functions', 'container_instances', 'service_fabric', 'batch'],
                'Network Services': ['virtual_network', 'vpn_gateway', 'expressroute', 'load_balancer', 'application_gateway', 'front_door', 'firewall', 'cdn', 'traffic_manager'],
                'Database Services': ['sql_database', 'sql_managed_instance', 'cosmos_db', 'mysql', 'postgresql', 'mariadb', 'redis'],
                'Storage Services': ['storage_accounts', 'blob_storage', 'queue_storage', 'table_storage', 'file_storage', 'disk_storage', 'data_lake'],
                'Security Services': ['key_vault', 'active_directory', 'security_center', 'sentinel', 'defender'],
                'Monitoring Services': ['monitor', 'log_analytics', 'application_insights', 'service_health', 'advisor'],
                'AI/ML Services': ['cognitive_services', 'machine_learning', 'bot_service', 'form_recognizer'],
                'Analytics Services': ['synapse', 'data_factory', 'databricks', 'stream_analytics', 'power_bi'],
                'Integration Services': ['logic_apps', 'service_bus', 'event_grid', 'event_hubs', 'api_management'],
                'DevOps Services': ['devops', 'automation'],
                'Backup Services': ['backup', 'site_recovery']
            };

            let html = '<h4>Valid Service Names by Category:</h4>';
            for (const [category, serviceList] of Object.entries(services)) {
                html += `<div style="margin: 10px 0;"><strong>${category}:</strong><br>`;
                html += `<code>${serviceList.join(', ')}</code></div>`;
            }

            document.getElementById('service-reference').innerHTML = html;
        }

        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            document.getElementById('analysis-status').innerHTML = 
                '<span style="color: green;">‚úÖ System operational - Auto-correction active</span>';
        });
    </script>
</body>
</html>