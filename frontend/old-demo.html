<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Azure Landing Zone Agent — Demo</title>

    <!-- Fallback: if mermaid fails to load, we'll show the raw syntax -->
    <script>
        // Check if mermaid loaded, if not provide a fallback
        window.mermaidLoaded = false;
        window.addEventListener('load', function() {
            if (typeof mermaid === 'undefined') {
                console.warn('Mermaid library failed to load, will show raw syntax instead');
            } else {
                window.mermaidLoaded = true;
                mermaid.initialize({ startOnLoad: false, theme: "default" });
            }
        });
    </script>
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        label { display: block; margin-top: 12px; }
        select, button { padding: 6px; margin-top: 6px; }
        pre { background: #f6f6f6; padding: 10px; }
        #diagram { border: 1px solid #ccc; padding: 10px; min-height: 200px; }
    </style>
</head>
<body>
    <h2>Azure Landing Zone Agent — Demo</h2>

    <label>Business Objective:
        <select id="business">
            <option>Cost</option>
            <option>Agility</option>
            <option>Innovation</option>
            <option>Scalability</option>
        </select>
    </label>

    <label>Network Model:
        <select id="network">
            <option>Hub-Spoke</option>
            <option>Mesh</option>
            <option>Virtual WAN</option>
        </select>
    </label>

    <label>Workload:
        <select id="workload">
            <option>AKS</option>
            <option>App Services</option>
            <option>VMs</option>
            <option>Databases</option>
            <option>SAP</option>
            <option>AI/ML</option>
        </select>
    </label>

    <label>Monitoring:
        <select id="monitoring">
            <option>Azure Monitor</option>
            <option>Log Analytics</option>
            <option>Prometheus</option>
            <option>Grafana</option>
        </select>
    </label>

    <label>Security:
        <select id="security">
            <option>Zero Trust</option>
            <option>SIEM/SOAR</option>
        </select>
    </label>

    <br /><br />
    <button onclick="generateMermaid()">Generate (Mermaid)</button>
    <button onclick="generateDrawio()">Generate (Azure Icons - Draw.io)</button>

    <h3>Raw Mermaid Syntax (debug)</h3>
    <pre id="mermaidSyntax"></pre>

    <h3>Mermaid Diagram</h3>
    <div id="diagram"></div>

    <h3>Azure-Style Diagram (Draw.io)</h3>
    <div id="diagramContainer"></div>

    <script src="viewer.min.js"></script>

    <script>
        async function generateMermaid() {
            const payload = collectInputs();
            try {
                const res = await fetch("http://127.0.0.1:8001/generate-diagram", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                document.getElementById("mermaidSyntax").textContent = data.mermaid || "";
                const diagramDiv = document.getElementById("diagram");
                diagramDiv.innerHTML = "";
                
                if (window.mermaidLoaded && typeof mermaid !== 'undefined') {
                    const uniqueId = "graph-" + Date.now();
                    mermaid.render(uniqueId, data.mermaid.trim(), (svgCode) => {
                        diagramDiv.innerHTML = svgCode;
                    });
                } else {
                    // Fallback: show the raw mermaid syntax in a readable format
                    diagramDiv.innerHTML = `
                        <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 15px; font-family: 'Courier New', monospace; white-space: pre-wrap; line-height: 1.4;">
                            <strong>Mermaid Diagram (Raw Syntax):</strong><br><br>
                            ${data.mermaid.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            <br><br>
                            <em style="color: #6c757d;">Note: Mermaid rendering is not available. The diagram structure is shown above.</em>
                        </div>
                    `;
                }
                
                document.getElementById("tsd").textContent = data.tsd || "";
                document.getElementById("hld").textContent = data.hld || "";
                document.getElementById("lld").textContent = data.lld || "";
            } catch (err) {
                alert("❌ Error (Mermaid): " + err);
                console.error(err);
            }
        }

        async function generateDrawio() {
            const payload = collectInputs();
            try {
                const res = await fetch("http://127.0.0.1:8001/generate-drawio-inline", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const xml = await res.text();
                const diagramContainer = document.getElementById('diagramContainer');
                diagramContainer.innerHTML = ''; // Clear previous diagram
                
                // Parse the XML string to get the document element
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xml, "application/xml");
                
                // Create GraphViewer with container, xmlNode, and config
                const viewer = new GraphViewer(diagramContainer, xmlDoc.documentElement, {});
            } catch (err) {
                alert("❌ Error (Draw.io): " + err);
                console.error(err);
            }
        }

        function collectInputs() {
            return {
                business_objective: document.getElementById("business").value,
                network_model: document.getElementById("network").value,
                workload: document.getElementById("workload").value,
                monitoring: document.getElementById("monitoring").value,
                security_posture: document.getElementById("security").value,
            };
        }
    </script>

    <h3>TSD</h3>
    <pre id="tsd"></pre>

    <h3>HLD</h3>
    <pre id="hld"></pre>

    <h3>LLD</h3>
    <pre id="lld"></pre>
</body>
</html>
